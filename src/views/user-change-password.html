<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Change Password</h1>
        <p class="text-muted mb-0">Update your account password</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-key"></i> Password Change
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/change-password" id="changePasswordForm">
                    <input type="hidden" name="_csrf" value="{{csrfToken}}">

                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                        <div class="form-text">Enter your current password to verify your identity</div>
                    </div>

                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="8">
                        <div class="form-text">Must be at least 8 characters long</div>
                    </div>

                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required minlength="8">
                        <div class="form-text">Re-enter your new password to confirm</div>
                    </div>

                    <!-- Password strength indicator -->
                    <div class="mb-3">
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="form-text" id="passwordStrengthText">Password strength will be shown here</small>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-key"></i> Change Password
                        </button>
                        <a href="/" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i> Password Requirements
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        At least 8 characters long
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        Use a mix of letters, numbers, and symbols
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        Avoid common passwords
                    </li>
                    <li>
                        <i class="bi bi-check text-success"></i>
                        Don't reuse old passwords
                    </li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-triangle text-warning"></i> Important Note
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">
                    Changing your password will not automatically log you out of other sessions.
                    If you want to revoke all other sessions after changing your password,
                    you can do so from your <a href="/sessions">sessions page</a>.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const form = document.getElementById('changePasswordForm');
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('passwordStrengthText');

    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = [];

        if (password.length >= 8) {
            strength += 20;
        } else {
            feedback.push('At least 8 characters');
        }

        if (/[a-z]/.test(password)) {
            strength += 20;
        } else {
            feedback.push('lowercase letters');
        }

        if (/[A-Z]/.test(password)) {
            strength += 20;
        } else {
            feedback.push('uppercase letters');
        }

        if (/[0-9]/.test(password)) {
            strength += 20;
        } else {
            feedback.push('numbers');
        }

        if (/[^A-Za-z0-9]/.test(password)) {
            strength += 20;
        } else {
            feedback.push('special characters');
        }

        return { strength, feedback };
    }

    // Update password strength indicator
    newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        const result = checkPasswordStrength(password);

        strengthBar.style.width = result.strength + '%';
        strengthBar.className = 'progress-bar';

        if (result.strength < 40) {
            strengthBar.classList.add('bg-danger');
            strengthText.textContent = 'Weak - Add: ' + result.feedback.join(', ');
            strengthText.className = 'form-text text-danger';
        } else if (result.strength < 80) {
            strengthBar.classList.add('bg-warning');
            strengthText.textContent = 'Medium - Consider adding: ' + result.feedback.join(', ');
            strengthText.className = 'form-text text-warning';
        } else {
            strengthBar.classList.add('bg-success');
            strengthText.textContent = 'Strong password';
            strengthText.className = 'form-text text-success';
        }
    });

    // Form validation
    form.addEventListener('submit', function(e) {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('New passwords do not match');
            confirmPasswordInput.focus();
            return false;
        }

        if (newPassword.length < 8) {
            e.preventDefault();
            alert('New password must be at least 8 characters long');
            newPasswordInput.focus();
            return false;
        }
    });

    // Real-time password match checking
    function checkPasswordMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (confirmPassword && newPassword !== confirmPassword) {
            confirmPasswordInput.setCustomValidity('Passwords do not match');
            confirmPasswordInput.classList.add('is-invalid');
        } else {
            confirmPasswordInput.setCustomValidity('');
            confirmPasswordInput.classList.remove('is-invalid');
        }
    }

    newPasswordInput.addEventListener('input', checkPasswordMatch);
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
});
</script>